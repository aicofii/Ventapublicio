<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¥¨æ®åˆ—è¡¨ - è¶…å¸‚</title>
  <!-- Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Load React and ReactDOM -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.3.1/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.3.1/umd/react-dom.production.min.js"></script>
  <!-- Load Babel for JSX transformation -->
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.25.6/babel.min.js"></script>
  <!-- CDN Fallback Check -->
  <script>
    window.addEventListener('load', () => {
      if (!window.React || !window.ReactDOM || !window.Babel) {
        document.getElementById('error-message').classList.remove('hidden');
        document.getElementById('error-message').innerText = 
          'é”™è¯¯ï¼šæ— æ³•åŠ è½½å¿…è¦èµ„æºã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–å°è¯•ä½¿ç”¨å…¶ä»–æµè§ˆå™¨ï¼ˆå¦‚ Chromeã€Firefoxï¼‰ã€‚';
      }
    });
  </script>
</head>
<body class="bg-gray-100 font-sans">
  <!-- Fallback message if JavaScript fails -->
  <div id="error-message" className="hidden text-center p-4 text-red-600">
    é”™è¯¯ï¼šæ— æ³•åŠ è½½åº”ç”¨ç¨‹åºã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å¹¶åˆ·æ–°é¡µé¢ã€‚
  </div>
  <!-- Root element for React -->
  <div id="root"></div>

  <script type="text/babel">
    // Error Boundary Component
    class ErrorBoundary extends React.Component {
      state = { hasError: false, errorMessage: '' };
      static getDerivedStateFromError(error) {
        return { hasError: true, errorMessage: error.message };
      }
      render() {
        if (this.state.hasError) {
          return (
            <div className="text-red-600 p-4 text-center">
              æ¸²æŸ“åº”ç”¨ç¨‹åºæ—¶å‡ºé”™ï¼š{this.state.errorMessage}ã€‚è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°æˆ–è”ç³»æ”¯æŒã€‚
            </div>
          );
        }
        return this.props.children;
      }
    }

    // Search Panel Component
    function SearchPanel({ isOpen, onClose, onSearch, tickets }) {
      const [searchCustomer, setSearchCustomer] = React.useState("");
      const [searchType, setSearchType] = React.useState("");
      const [searchDate, setSearchDate] = React.useState("");
      const [searchAmount, setSearchAmount] = React.useState("");

      const handleSearch = () => {
        const filteredTickets = tickets.filter((ticket) => {
          const matchesCustomer = searchCustomer 
            ? (ticket.customerName || "æ™®é€šå®¢æˆ·").toLowerCase().includes(searchCustomer.toLowerCase()) 
            : true;
          const matchesType = searchType ? ticket.type === searchType : true;
          const matchesDate = searchDate ? ticket.timestamp.includes(searchDate) : true;
          const matchesAmount = searchAmount 
            ? ticket.total.toFixed(2) === parseFloat(searchAmount).toFixed(2) 
            : true;
          return matchesCustomer && matchesType && matchesDate && matchesAmount;
        });
        onSearch(filteredTickets);
        setSearchCustomer("");
        setSearchType("");
        setSearchDate("");
        setSearchAmount("");
        onClose();
      };

      return (
        <div
          className={`fixed top-0 right-0 h-full w-1/3 bg-white shadow-lg z-50 transform transition-transform duration-300 ease-in-out ${
            isOpen ? 'translate-x-0' : 'translate-x-full'
          }`}
        >
          <div className="p-6 h-full flex flex-col">
            <h2 className="text-xl font-bold mb-4">æŸ¥è¯¢ç¥¨æ®</h2>
            <div className="flex-1 space-y-4">
              <div>
                <label className="block text-sm font-medium mb-1">å®¢æˆ·</label>
                <input
                  type="text"
                  value={searchCustomer}
                  onChange={(e) => setSearchCustomer(e.target.value)}
                  placeholder="è¾“å…¥å®¢æˆ·åç§°"
                  className="border p-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                  autoFocus
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">ç±»å‹</label>
                <select
                  value={searchType}
                  onChange={(e) => setSearchType(e.target.value)}
                  className="border p-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="">æ‰€æœ‰ç±»å‹</option>
                  <option value="å°ç¥¨">å°ç¥¨</option>
                  <option value="å‘ç¥¨">å‘ç¥¨</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">æ—¥æœŸ</label>
                <input
                  type="date"
                  value={searchDate}
                  onChange={(e) => setSearchDate(e.target.value)}
                  className="border p-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">é‡‘é¢</label>
                <input
                  type="number"
                  step="0.01"
                  value={searchAmount}
                  onChange={(e) => setSearchAmount(e.target.value)}
                  placeholder="è¾“å…¥é‡‘é¢"
                  className="border p-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
            </div>
            <div className="flex justify-end space-x-2 mt-4">
              <button
                onClick={onClose}
                className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
              >
                å–æ¶ˆ
              </button>
              <button
                onClick={handleSearch}
                className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
              >
                ç¡®å®š
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Ticket Details Modal Component
    function TicketDetailsModal({ isOpen, onClose, ticket }) {
      if (!isOpen || !ticket) return null;

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 w-1/2">
            <h2 className="text-xl font-bold mb-4">ç¥¨æ®è¯¦æƒ… - {ticket.id}</h2>
            <p className="mb-2"><strong>æ—¶é—´ï¼š</strong>{ticket.timestamp}</p>
            <p className="mb-2"><strong>å®¢æˆ·ï¼š</strong>{ticket.customerName ? ticket.customerName : "æ™®é€šå®¢æˆ·"}</p>
            {ticket.type === "å‘ç¥¨" && (
              <>
                {ticket.phone && <p className="mb-2"><strong>ç”µè¯ï¼š</strong>{ticket.phone}</p>}
                {ticket.taxId && <p className="mb-2"><strong>ç¨å·ï¼š</strong>{ticket.taxId}</p>}
              </>
            )}
            {ticket.paymentMethod && (
              <p className="mb-2"><strong>æ”¯ä»˜æ–¹å¼ï¼š</strong>{ticket.paymentMethod === "card" ? "åˆ·å¡" : "ç°é‡‘"}</p>
            )}
            <p className="mb-4"><strong>æ€»è®¡ï¼š</strong>â‚¬{ticket.total.toFixed(2)}</p>
            {ticket.tickets && (
              <>
                <h3 className="text-lg font-semibold mb-2">åŒ…å«çš„å°ç¥¨</h3>
                <ul className="list-disc pl-5 mb-4">
                  {ticket.tickets.map((ticketId, index) => (
                    <li key={index}>{ticketId}</li>
                  ))}
                </ul>
              </>
            )}
            <h3 className="text-lg font-semibold mb-2">å•†å“åˆ—è¡¨</h3>
            <table className="w-full border-collapse">
              <thead>
                <tr className="bg-gray-200">
                  <th className="border p-3 text-left">äº§å“</th>
                  <th className="border p-3 text-left">å•ä»·</th>
                  <th className="border p-3 text-left">æ•°é‡</th>
                  <th className="border p-3 text-left">æ€»è®¡</th>
                </tr>
              </thead>
              <tbody>
                {ticket.items.map((item, index) => (
                  <tr key={index}>
                    <td className="border p-3">{item.name}</td>
                    <td className="border p-3">â‚¬{item.price.toFixed(2)}</td>
                    <td className="border p-3">{item.quantity}</td>
                    <td className="border p-3">â‚¬{(item.price * item.quantity).toFixed(2)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
            {ticket.discount !== undefined && (
              <p className="mt-4"><strong>æŠ˜æ‰£ï¼š</strong>{ticket.discount}%</p>
            )}
            <button
              onClick={onClose}
              className="mt-4 bg-gray-500 text-white p-2 rounded w-full hover:bg-gray-600"
            >
              å…³é—­
            </button>
          </div>
        </div>
      );
    }

    // Create Customer Modal Component
    function CreateCustomerModal({ isOpen, onClose, onSave }) {
      const [formData, setFormData] = React.useState({
        id: '',
        name: '',
        taxNumber: '',
        address: '',
        phone: ''
      });

      const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData((prev) => ({ ...prev, [name]: value }));
      };

      const handleSubmit = () => {
        if (!formData.id || !formData.name || !formData.phone) {
          alert('å®¢æˆ·ä»£ç ã€å®¢æˆ·åç§°å’Œç”µè¯ä¸ºå¿…å¡«é¡¹ï¼');
          return;
        }
        onSave(formData);
        setFormData({ id: '', name: '', taxNumber: '', address: '', phone: '' });
        onClose();
      };

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
            <h3 className="text-lg font-bold mb-4">åˆ›å»ºå®¢æˆ·</h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700">å®¢æˆ·ä»£ç </label>
                <input
                  type="text"
                  name="id"
                  value={formData.id}
                  onChange={handleChange}
                  className="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="è¯·è¾“å…¥å®¢æˆ·ä»£ç "
                  required
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">å®¢æˆ·åç§°</label>
                <input
                  type="text"
                  name="name"
                  value={formData.name}
                  onChange={handleChange}
                  className="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="è¯·è¾“å…¥å®¢æˆ·åç§°"
                  required
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">å®¢æˆ·ç¨å·</label>
                <input
                  type="text"
                  name="taxNumber"
                  value={formData.taxNumber}
                  onChange={handleChange}
                  className="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="è¯·è¾“å…¥å®¢æˆ·ç¨å·"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">å®¢æˆ·åœ°å€</label>
                <input
                  type="text"
                  name="address"
                  value={formData.address}
                  onChange={handleChange}
                  className="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="è¯·è¾“å…¥å®¢æˆ·åœ°å€"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">å®¢æˆ·ç”µè¯</label>
                <input
                  type="text"
                  name="phone"
                  value={formData.phone}
                  onChange={handleChange}
                  className="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="è¯·è¾“å…¥å®¢æˆ·ç”µè¯"
                  required
                />
              </div>
            </div>
            <div className="mt-6 flex justify-end space-x-2">
              <button
                onClick={onClose}
                className="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400"
              >
                å–æ¶ˆ
              </button>
              <button
                onClick={handleSubmit}
                className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
              >
                ä¿å­˜
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Invoice Modal Component for Regular Customers
    function InvoiceModal({ isOpen, onClose, onConfirm, ticketId }) {
      const [customerName, setCustomerName] = React.useState("");
      const [phone, setPhone] = React.useState("");
      const [taxId, setTaxId] = React.useState("");
      const [isCreateCustomerModalOpen, setIsCreateCustomerModalOpen] = React.useState(false);

      // Load customers from localStorage
      const customers = JSON.parse(localStorage.getItem("customers") || "[]");

      // Auto-fill fields based on input
      const autoFillFields = (field, value) => {
        const matchingCustomer = customers.find(customer => 
          (field === "name" && customer.name === value) ||
          (field === "phone" && customer.phone === value) ||
          (field === "taxNumber" && customer.taxNumber === value)
        );
        if (matchingCustomer) {
          setCustomerName(matchingCustomer.name || "");
          setPhone(matchingCustomer.phone || "");
          setTaxId(matchingCustomer.taxNumber || "");
        }
      };

      const handleCustomerNameChange = (e) => {
        const value = e.target.value;
        setCustomerName(value);
        autoFillFields("name", value);
      };

      const handlePhoneChange = (e) => {
        const value = e.target.value;
        setPhone(value);
        autoFillFields("phone", value);
      };

      const handleTaxIdChange = (e) => {
        const value = e.target.value;
        setTaxId(value);
        autoFillFields("taxNumber", value);
      };

      const handleConfirm = () => {
        onConfirm({ customerName, phone, taxId });
        setCustomerName("");
        setPhone("");
        setTaxId("");
        onClose();
      };

      const handleSaveCustomer = (newCustomer) => {
        const updatedCustomers = [...customers, newCustomer];
        localStorage.setItem("customers", JSON.stringify(updatedCustomers));
        setCustomerName(newCustomer.name || "");
        setPhone(newCustomer.phone || "");
        setTaxId(newCustomer.taxNumber || "");
      };

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 w-1/3">
            <h2 className="text-xl font-bold mb-4">å¡«å†™å‘ç¥¨ä¿¡æ¯ - {ticketId}</h2>
            <div className="mb-4">
              <label className="block text-sm font-medium mb-1">å®¢æˆ·åç§°</label>
              <input
                type="text"
                value={customerName}
                onChange={handleCustomerNameChange}
                placeholder="è¾“å…¥å®¢æˆ·åç§°"
                className="border p-2 rounded w-full"
                autoFocus
              />
            </div>
            <div className="mb-4">
              <label className="block text-sm font-medium mb-1">ç”µè¯</label>
              <input
                type="tel"
                value={phone}
                onChange={handlePhoneChange}
                placeholder="è¾“å…¥ç”µè¯å·ç "
                className="border p-2 rounded w-full"
              />
            </div>
            <div className="mb-4">
              <label className="block text-sm font-medium mb-1">ç¨å·</label>
              <input
                type="text"
                value={taxId}
                onChange={handleTaxIdChange}
                placeholder="è¾“å…¥ç¨å·"
                className="border p-2 rounded w-full"
              />
            </div>
            <button
              onClick={handleConfirm}
              className="bg-blue-600 text-white p-2 rounded w-full mb-4 hover:bg-blue-700"
            >
              ç¡®è®¤
            </button>
            <button
              onClick={() => setIsCreateCustomerModalOpen(true)}
              className="bg-green-600 text-white p-2 rounded w-full mb-4 hover:bg-green-700"
            >
              åˆ›å»ºå®¢æˆ·
            </button>
            <button
              onClick={onClose}
              className="bg-gray-500 text-white p-2 rounded w-full hover:bg-gray-600"
            >
              å–æ¶ˆ
            </button>
            <CreateCustomerModal
              isOpen={isCreateCustomerModalOpen}
              onClose={() => setIsCreateCustomerModalOpen(false)}
              onSave={handleSaveCustomer}
            />
          </div>
        </div>
      );
    }

    // Confirm Invoice Modal for Customers with Existing Info
    function ConfirmInvoiceModal({ isOpen, onClose, onConfirm, ticketId }) {
      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 w-1/3">
            <h2 className="text-xl font-bold mb-4">ç¡®è®¤å¼€å‘ç¥¨ - {ticketId}</h2>
            <p className="mb-4">ç¡®è®¤ä¸ºæ­¤ç¥¨æ®å¼€å‘ç¥¨å—ï¼Ÿ</p>
            <button
              onClick={onConfirm}
              className="bg-blue-600 text-white p-2 rounded w-full mb-4 hover:bg-blue-700"
            >
              ç¡®è®¤
            </button>
            <button
              onClick={onClose}
              className="bg-gray-500 text-white p-2 rounded w-full hover:bg-gray-600"
            >
              å–æ¶ˆ
            </button>
          </div>
        </div>
      );
    }

    // Main Tickets Component
    function TicketsApp() {
      const [tickets, setTickets] = React.useState([]);
      const [isSearchPanelOpen, setIsSearchPanelOpen] = React.useState(false);
      const [selectedTicket, setSelectedTicket] = React.useState(null);
      const [isInvoiceModalOpen, setIsInvoiceModalOpen] = React.useState(false);
      const [isConfirmInvoiceModalOpen, setIsConfirmInvoiceModalOpen] = React.useState(false);
      const [currentInvoiceTicketId, setCurrentInvoiceTicketId] = React.useState(null);
      const [currentPage, setCurrentPage] = React.useState(1);
      const ticketsPerPage = 10;

      // Load tickets and invoices from localStorage on component mount and listen for storage changes
      React.useEffect(() => {
        const loadTicketsAndInvoices = () => {
          const savedTickets = JSON.parse(localStorage.getItem("tickets") || "[]");
          const savedInvoices = JSON.parse(localStorage.getItem("invoices") || "[]");

          // Initialize type as "å°ç¥¨" for tickets if not present
          const updatedTickets = savedTickets.map(ticket => ({
            ...ticket,
            type: ticket.type || "å°ç¥¨"
          }));

          // Format invoices to match ticket structure for display
          const formattedInvoices = savedInvoices.map(invoice => ({
            ...invoice,
            type: "å‘ç¥¨",
            paymentMethod: undefined, // Invoices don't have paymentMethod
            discount: 0 // Invoices don't have discount in current structure
          }));

          // Combine tickets and invoices, sort by timestamp in descending order
          const combinedTickets = [...updatedTickets, ...formattedInvoices].sort((a, b) => 
            new Date(b.timestamp) - new Date(a.timestamp)
          );

          setTickets(combinedTickets);
        };

        loadTicketsAndInvoices();

        window.addEventListener('storage', loadTicketsAndInvoices);
        return () => window.removeEventListener('storage', loadTicketsAndInvoices);
      }, []);

      const handleSearch = (filteredTickets) => {
        const sortedFilteredTickets = filteredTickets.sort((a, b) => 
          new Date(b.timestamp) - new Date(a.timestamp)
        );
        setTickets(sortedFilteredTickets);
        setCurrentPage(1);
      };

      const handleViewDetails = (ticket) => {
        setSelectedTicket(ticket);
      };

      const handleInvoice = (ticket) => {
        if (ticket.type === "å‘ç¥¨") return; // Prevent invoicing an invoice
        setCurrentInvoiceTicketId(ticket.id);
        if (ticket.customerName && ticket.customerName !== "æ™®é€šå®¢æˆ·") {
          setIsConfirmInvoiceModalOpen(true);
        } else {
          setIsInvoiceModalOpen(true);
        }
      };

      const handleInvoiceConfirm = ({ customerName, phone, taxId }) => {
        const updatedTickets = tickets.map(ticket => 
          ticket.id === currentInvoiceTicketId && ticket.type !== "å‘ç¥¨"
            ? { ...ticket, type: "å‘ç¥¨", customerName, phone, taxId }
            : ticket
        );
        // Update only the tickets array in localStorage, preserve invoices
        const updatedLocalTickets = updatedTickets.filter(ticket => !ticket.tickets);
        localStorage.setItem("tickets", JSON.stringify(updatedLocalTickets));
        setTickets(updatedTickets);
      };

      const handleConfirmInvoice = () => {
        const updatedTickets = tickets.map(ticket => 
          ticket.id === currentInvoiceTicketId && ticket.type !== "å‘ç¥¨"
            ? { ...ticket, type: "å‘ç¥¨" }
            : ticket
        );
        // Update only the tickets array in localStorage, preserve invoices
        const updatedLocalTickets = updatedTickets.filter(ticket => !ticket.tickets);
        localStorage.setItem("tickets", JSON.stringify(updatedLocalTickets));
        setTickets(updatedTickets);
        setIsConfirmInvoiceModalOpen(false);
      };

      // Pagination logic
      const indexOfLastTicket = currentPage * ticketsPerPage;
      const indexOfFirstTicket = indexOfLastTicket - ticketsPerPage;
      const currentTickets = tickets.slice(indexOfFirstTicket, indexOfLastTicket);
      const totalPages = Math.ceil(tickets.length / ticketsPerPage);

      const handlePageChange = (pageNumber) => {
        setCurrentPage(pageNumber);
      };

      return (
        <ErrorBoundary>
          <div className="flex h-screen">
            {/* Sidebar */}
            <div className="w-16 bg-gray-900 text-white flex flex-col items-center py-4 fixed h-full shadow-lg">
              <h1 className="text-lg font-bold mb-8">POS</h1>
              <nav className="flex flex-col space-y-4">
                <a
                  href="index.html"
                  className="p-2 rounded-full hover:bg-gray-700"
                  title="é”€å”®"
                >
                  ğŸ›’
                </a>
                <a
                  href="#"
                  className="p-2 rounded-full hover:bg-gray-700"
                  title="åº“å­˜"
                >
                  ğŸ“¦
                </a>
                <a
                  href="#"
                  className="p-2 rounded-full hover:bg-gray-700"
                  title="ä¼šå‘˜"
                >
                  ğŸ‘¤
                </a>
                <a
                  href="#"
                  className="p-2 rounded-full hover:bg-gray-700"
                  title="æ”¯ä»˜"
                >
                  ğŸ’³
                </a>
                <a
                  href="#"
                  className="p-2 rounded-full hover:bg-gray-700"
                  title="æŠ¥å‘Š"
                >
                  ğŸ“Š
                </a>
                <a
                  href="cliente.html"
                  className="p-2 rounded-full hover:bg-gray-700"
                  title="ç”¨æˆ·"
                >
                  ğŸ”’
                </a>
                <button
                  className="p-2 rounded-full bg-blue-600"
                  title="ç¥¨æ®"
                >
                  ğŸ«
                </button>
                <a
                  href="deuda.html"
                  className="p-2 rounded-full hover:bg-gray-700"
                  title="è®°è´¦"
                >
                  ğŸ“‹
                </a>
              </nav>
            </div>
            {/* Main Content */}
            <div className="ml-16 w-full bg-white p-6">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-bold">ç¥¨æ®åˆ—è¡¨</h2>
                <div className="flex space-x-2">
                  <button
                    onClick={() => window.location.href = 'batch_invoice.html'}
                    className="bg-green-600 text-white p-3 rounded text-lg hover:bg-green-700"
                  >
                    æ‰¹é‡å¼€ç¥¨
                  </button>
                  <button
                    onClick={() => setIsSearchPanelOpen(true)}
                    className="bg-blue-600 text-white p-3 rounded text-lg hover:bg-blue-700"
                  >
                    æŸ¥è¯¢ç¥¨æ®
                  </button>
                </div>
              </div>
              {tickets.length === 0 ? (
                <p className="text-gray-500">æ²¡æœ‰æ‰¾åˆ°ç¥¨æ®ã€‚è¯·å°è¯•åœ¨é”€å”®é¡µé¢å®Œæˆä¸€ç¬”äº¤æ˜“ã€‚</p>
              ) : (
                <div>
                  <table className="w-full border-collapse">
                    <thead>
                      <tr className="bg-gray-200">
                        <th className="border p-3 text-left">äº¤æ˜“ID</th>
                        <th className="border p-3 text-left">ç±»å‹</th>
                        <th className="border p-3 text-left">æ—¶é—´</th>
                        <th className="border p-3 text-left">å®¢æˆ·</th>
                        <th className="border p-3 text-left">æ€»è®¡</th>
                        <th className="border p-3 text-left">æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody>
                      {currentTickets.map((ticket) => (
                        <tr key={ticket.id}>
                          <td className="border p-3">{ticket.id}</td>
                          <td className="border p-3">{ticket.type}</td>
                          <td className="border p-3">{ticket.timestamp}</td>
                          <td className="border p-3">{ticket.customerName ? ticket.customerName : "æ™®é€šå®¢æˆ·"}</td>
                          <td className="border p-3">â‚¬{ticket.total.toFixed(2)}</td>
                          <td className="border p-3 flex space-x-2">
                            <button
                              onClick={() => handleViewDetails(ticket)}
                              className="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600"
                            >
                              æŸ¥çœ‹è¯¦æƒ…
                            </button>
                            <button
                              onClick={() => handleInvoice(ticket)}
                              className="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600"
                              disabled={ticket.type === "å‘ç¥¨"}
                            >
                              å‘ç¥¨
                            </button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                  {/* Pagination Controls */}
                  {totalPages > 1 && (
                    <div className="flex justify-end items-center mt-4 space-x-2">
                      <button
                        onClick={() => handlePageChange(currentPage - 1)}
                        disabled={currentPage === 1}
                        className="bg-gray-300 text-gray-700 px-4 py-2 rounded disabled:opacity-50 hover:bg-gray-400"
                      >
                        ä¸Šä¸€é¡µ
                      </button>
                      <span className="text-gray-700">
                        ç¬¬ {currentPage} é¡µ / å…± {totalPages} é¡µ
                      </span>
                      <button
                        onClick={() => handlePageChange(currentPage + 1)}
                        disabled={currentPage === totalPages}
                        className="bg-gray-300 text-gray-700 px-4 py-2 rounded disabled:opacity-50 hover:bg-gray-400"
                      >
                        ä¸‹ä¸€é¡µ
                      </button>
                    </div>
                  )}
                </div>
              )}
              <SearchPanel
                isOpen={isSearchPanelOpen}
                onClose={() => setIsSearchPanelOpen(false)}
                onSearch={handleSearch}
                tickets={[...JSON.parse(localStorage.getItem("tickets") || "[]"), 
                         ...JSON.parse(localStorage.getItem("invoices") || "[]").map(invoice => ({
                           ...invoice,
                           type: "å‘ç¥¨",
                           paymentMethod: undefined,
                           discount: 0
                         }))]} // Pass combined tickets and invoices for filtering
              />
              <TicketDetailsModal
                isOpen={!!selectedTicket}
                onClose={() => setSelectedTicket(null)}
                ticket={selectedTicket}
              />
              <InvoiceModal
                isOpen={isInvoiceModalOpen}
                onClose={() => setIsInvoiceModalOpen(false)}
                onConfirm={handleInvoiceConfirm}
                ticketId={currentInvoiceTicketId}
              />
              <ConfirmInvoiceModal
                isOpen={isConfirmInvoiceModalOpen}
                onClose={() => setIsConfirmInvoiceModalOpen(false)}
                onConfirm={handleConfirmInvoice}
                ticketId={currentInvoiceTicketId}
              />
            </div>
          </div>
        </ErrorBoundary>
      );
    }

    // Render the app using createRoot
    const rootElement = document.getElementById("root");
    const root = ReactDOM.createRoot(rootElement);
    root.render(<TicketsApp />);
  </script>
</body>
</html>