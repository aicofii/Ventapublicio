<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‰¹é‡å¼€ç¥¨ - è¶…å¸‚</title>
  <!-- Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Load React and ReactDOM -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.3.1/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.3.1/umd/react-dom.production.min.js"></script>
  <!-- Load Babel for JSX transformation -->
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.25.6/babel.min.js"></script>
  <!-- CDN Fallback Check -->
  <script>
    window.addEventListener('load', () => {
      if (!window.React || !window.ReactDOM || !window.Babel) {
        document.getElementById('error-message').classList.remove('hidden');
        document.getElementById('error-message').innerText = 
          localStorage.getItem('language') === 'es' 
            ? 'Error: No se pudieron cargar los recursos necesarios. Verifica tu conexiÃ³n a internet o intenta con otro navegador (como Chrome o Firefox).'
            : 'é”™è¯¯ï¼šæ— æ³•åŠ è½½å¿…è¦èµ„æºã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–å°è¯•ä½¿ç”¨å…¶ä»–æµè§ˆå™¨ï¼ˆå¦‚ Chromeã€Firefoxï¼‰ã€‚';
      }
    });
  </script>
</head>
<body class="bg-gray-100 font-sans">
  <!-- Fallback message if JavaScript fails -->
  <div id="error-message" className="hidden text-center p-4 text-red-600"></div>
  <!-- Root element for React -->
  <div id="root"></div>

  <script type="text/babel">
    // Translations object
    const translations = {
      zh: {
        title: "æ‰¹é‡å¼€ç¥¨ - è¶…å¸‚",
        pos: "POS",
        sales: "é”€å”®",
        inventory: "åº“å­˜",
        membership: "ä¼šå‘˜",
        payments: "æ”¯ä»˜",
        reports: "æŠ¥å‘Š",
        users: "ç”¨æˆ·",
        tickets: "ç¥¨æ®",
        debt: "è®°è´¦",
        batchInvoice: "æ‰¹é‡å¼€ç¥¨",
        return: "è¿”å›",
        search: "æŸ¥è¯¢",
        ticketId: "ç¥¨å·",
        amount: "é‡‘é¢",
        date: "æ—¥æœŸ",
        customerName: "å®¢æˆ·åç§°",
        customerNamePlaceholder: "è¾“å…¥å®¢æˆ·åç§°",
        availableTickets: "å¯ç”¨å°ç¥¨",
        noTickets: "æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å°ç¥¨",
        selectedTickets: "å·²é€‰å°ç¥¨",
        noSelectedTickets: "æš‚æ— å·²é€‰å°ç¥¨",
        clear: "æ¸…ç©º",
        createInvoice: "å¼€ç¥¨",
        totalAmount: "å…± â‚¬{amount}",
        ticketIdPlaceholder: "è¾“å…¥ç¥¨å·",
        amountPlaceholder: "è¾“å…¥é‡‘é¢",
        customer: "å®¢æˆ·",
        total: "æ€»è®¡",
        actions: "æ“ä½œ",
        invoiceInfo: "å¡«å†™å‘ç¥¨ä¿¡æ¯",
        createCustomer: "åˆ›å»ºå®¢æˆ·",
        customerCode: "å®¢æˆ·ä»£ç ",
        customerCodePlaceholder: "è¯·è¾“å…¥å®¢æˆ·ä»£ç ",
        customerName: "å®¢æˆ·åç§°",
        customerNamePlaceholder: "è¯·è¾“å…¥å®¢æˆ·åç§°",
        customerTaxNumber: "å®¢æˆ·ç¨å·",
        customerTaxNumberPlaceholder: "è¯·è¾“å…¥å®¢æˆ·ç¨å·",
        customerAddress: "å®¢æˆ·åœ°å€",
        customerAddressPlaceholder: "è¯·è¾“å…¥å®¢æˆ·åœ°å€",
        customerPhone: "å®¢æˆ·ç”µè¯",
        customerPhonePlaceholder: "è¯·è¾“å…¥å®¢æˆ·ç”µè¯",
        cancel: "å–æ¶ˆ",
        confirm: "ç¡®è®¤",
        save: "ä¿å­˜",
        errorCustomerRequired: "å®¢æˆ·ä»£ç ã€å®¢æˆ·åç§°å’Œç”µè¯ä¸ºå¿…å¡«é¡¹ï¼",
        errorNoTicketsSelected: "è¯·è‡³å°‘é€‰æ‹©ä¸€å¼ å°ç¥¨è¿›è¡Œå¼€ç¥¨ï¼",
        errorGenerateInvoice: "ç”Ÿæˆå‘ç¥¨æ—¶å‡ºé”™ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æˆ–è”ç³»æ”¯æŒã€‚",
        selectLanguage: "é€‰æ‹©è¯­è¨€",
        spanish: "è¥¿ç­ç‰™è¯­",
        chinese: "ä¸­æ–‡",
        errorRender: "æ¸²æŸ“åº”ç”¨ç¨‹åºæ—¶å‡ºé”™ï¼š{error}ã€‚è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°æˆ–è”ç³»æ”¯æŒã€‚",
        defaultCustomer: "æ™®é€šå®¢æˆ·",
        ticket: "å°ç¥¨"
      },
      es: {
        title: "FacturaciÃ³n Masiva - Supermercado",
        pos: "POS",
        sales: "Ventas",
        inventory: "Inventario",
        membership: "MembresÃ­a",
        payments: "Pagos",
        reports: "Informes",
        users: "Usuarios",
        tickets: "Tickets",
        debt: "Deuda",
        batchInvoice: "FacturaciÃ³n Masiva",
        return: "Regresar",
        search: "Buscar",
        ticketId: "NÃºmero de Ticket",
        amount: "Monto",
        date: "Fecha",
        customerName: "Nombre del Cliente",
        customerNamePlaceholder: "Ingresa el nombre del cliente",
        availableTickets: "Tickets Disponibles",
        noTickets: "No se encontraron tickets que coincidan con los criterios.",
        selectedTickets: "Tickets Seleccionados",
        noSelectedTickets: "No hay tickets seleccionados.",
        clear: "Vaciar",
        createInvoice: "Facturar",
        totalAmount: "Total â‚¬{amount}",
        ticketIdPlaceholder: "Ingresa el nÃºmero de ticket",
        amountPlaceholder: "Ingresa el monto",
        customer: "Cliente",
        total: "Total",
        actions: "Acciones",
        invoiceInfo: "Completar InformaciÃ³n de Factura",
        createCustomer: "Crear Cliente",
        customerCode: "CÃ³digo de Cliente",
        customerCodePlaceholder: "Ingresa el cÃ³digo de cliente",
        customerName: "Nombre del Cliente",
        customerNamePlaceholder: "Ingresa el nombre del cliente",
        customerTaxNumber: "NÃºmero de IdentificaciÃ³n Fiscal",
        customerTaxNumberPlaceholder: "Ingresa el nÃºmero de identificaciÃ³n fiscal",
        customerAddress: "DirecciÃ³n del Cliente",
        customerAddressPlaceholder: "Ingresa la direcciÃ³n del cliente",
        customerPhone: "TelÃ©fono del Cliente",
        customerPhonePlaceholder: "Ingresa el telÃ©fono del cliente",
        cancel: "Cancelar",
        confirm: "Confirmar",
        save: "Guardar",
        errorCustomerRequired: "Â¡El cÃ³digo, nombre y telÃ©fono del cliente son obligatorios!",
        errorNoTicketsSelected: "Â¡Por favor, selecciona al menos un ticket para facturar!",
        errorGenerateInvoice: "Error al generar la factura, consulta la consola o contacta al soporte.",
        selectLanguage: "Seleccionar Idioma",
        spanish: "EspaÃ±ol",
        chinese: "Chino",
        errorRender: "Error al renderizar la aplicaciÃ³n: {error}. Consulta la consola del navegador o contacta al soporte.",
        defaultCustomer: "Cliente Normal",
        ticket: "Ticket"
      }
    };

    // Error Boundary Component
    class ErrorBoundary extends React.Component {
      state = { hasError: false, errorMessage: '' };
      static getDerivedStateFromError(error) {
        return { hasError: true, errorMessage: error.message };
      }
      render() {
        if (this.state.hasError) {
          return (
            <div className="text-red-600 p-4 text-center">
              {this.props.t.errorRender.replace('{error}', this.state.errorMessage)}
            </div>
          );
        }
        return this.props.children;
      }
    }

    // Create Customer Modal Component
    function CreateCustomerModal({ isOpen, onClose, onSave, t }) {
      const [formData, setFormData] = React.useState({
        id: '',
        name: '',
        taxNumber: '',
        address: '',
        phone: ''
      });

      const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData((prev) => ({ ...prev, [name]: value }));
      };

      const handleSubmit = () => {
        if (!formData.id || !formData.name || !formData.phone) {
          alert(t.errorCustomerRequired);
          return;
        }
        onSave(formData);
        setFormData({ id: '', name: '', taxNumber: '', address: '', phone: '' });
        onClose();
      };

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
            <h3 className="text-lg font-bold mb-4">{t.createCustomer}</h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700">{t.customerCode}</label>
                <input
                  type="text"
                  name="id"
                  value={formData.id}
                  onChange={handleChange}
                  className="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder={t.customerCodePlaceholder}
                  required
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">{t.customerName}</label>
                <input
                  type="text"
                  name="name"
                  value={formData.name}
                  onChange={handleChange}
                  className="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder={t.customerNamePlaceholder}
                  required
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">{t.customerTaxNumber}</label>
                <input
                  type="text"
                  name="taxNumber"
                  value={formData.taxNumber}
                  onChange={handleChange}
                  className="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder={t.customerTaxNumberPlaceholder}
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">{t.customerAddress}</label>
                <input
                  type="text"
                  name="address"
                  value={formData.address}
                  onChange={handleChange}
                  className="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder={t.customerAddressPlaceholder}
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">{t.customerPhone}</label>
                <input
                  type="text"
                  name="phone"
                  value={formData.phone}
                  onChange={handleChange}
                  className="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder={t.customerPhonePlaceholder}
                  required
                />
              </div>
            </div>
            <div className="mt-6 flex justify-end space-x-2">
              <button
                onClick={onClose}
                className="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400"
              >
                {t.cancel}
              </button>
              <button
                onClick={handleSubmit}
                className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
              >
                {t.save}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Invoice Modal Component for Batch Invoicing
    function InvoiceModal({ isOpen, onClose, onConfirm, t }) {
      const [customerName, setCustomerName] = React.useState("");
      const [phone, setPhone] = React.useState("");
      const [taxId, setTaxId] = React.useState("");
      const [isCreateCustomerModalOpen, setIsCreateCustomerModalOpen] = React.useState(false);

      // Load customers from localStorage
      const customers = JSON.parse(localStorage.getItem("customers") || "[]");

      // Auto-fill fields based on input
      const autoFillFields = (field, value) => {
        const matchingCustomer = customers.find(customer => 
          (field === "name" && customer.name === value) ||
          (field === "phone" && customer.phone === value) ||
          (field === "taxNumber" && customer.taxNumber === value)
        );
        if (matchingCustomer) {
          setCustomerName(matchingCustomer.name || "");
          setPhone(matchingCustomer.phone || "");
          setTaxId(matchingCustomer.taxNumber || "");
        }
      };

      const handleCustomerNameChange = (e) => {
        const value = e.target.value;
        setCustomerName(value);
        autoFillFields("name", value);
      };

      const handlePhoneChange = (e) => {
        const value = e.target.value;
        setPhone(value);
        autoFillFields("phone", value);
      };

      const handleTaxIdChange = (e) => {
        const value = e.target.value;
        setTaxId(value);
        autoFillFields("taxNumber", value);
      };

      const handleConfirm = () => {
        onConfirm({ customerName, phone, taxId });
        setCustomerName("");
        setPhone("");
        setTaxId("");
        onClose();
      };

      const handleSaveCustomer = (newCustomer) => {
        const updatedCustomers = [...customers, newCustomer];
        localStorage.setItem("customers", JSON.stringify(updatedCustomers));
        setCustomerName(newCustomer.name || "");
        setPhone(newCustomer.phone || "");
        setTaxId(newCustomer.taxNumber || "");
      };

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 w-1/3">
            <h2 className="text-xl font-bold mb-4">{t.invoiceInfo}</h2>
            <div className="mb-4">
              <label className="block text-sm font-medium mb-1">{t.customerName}</label>
              <input
                type="text"
                value={customerName}
                onChange={handleCustomerNameChange}
                placeholder={t.customerNamePlaceholder}
                className="border p-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                autoFocus
              />
            </div>
            <div className="mb-4">
              <label className="block text-sm font-medium mb-1">{t.customerPhone}</label>
              <input
                type="tel"
                value={phone}
                onChange={handlePhoneChange}
                placeholder={t.customerPhonePlaceholder}
                className="border p-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div className="mb-4">
              <label className="block text-sm font-medium mb-1">{t.customerTaxNumber}</label>
              <input
                type="text"
                value={taxId}
                onChange={handleTaxIdChange}
                placeholder={t.customerTaxNumberPlaceholder}
                className="border p-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <button
              onClick={handleConfirm}
              className="bg-blue-600 text-white p-2 rounded w-full mb-4 hover:bg-blue-700"
            >
              {t.confirm}
            </button>
            <button
              onClick={() => setIsCreateCustomerModalOpen(true)}
              className="bg-green-600 text-white p-2 rounded w-full mb-4 hover:bg-green-700"
            >
              {t.createCustomer}
            </button>
            <button
              onClick={onClose}
              className="bg-gray-500 text-white p-2 rounded w-full hover:bg-gray-600"
            >
              {t.cancel}
            </button>
            <CreateCustomerModal
              isOpen={isCreateCustomerModalOpen}
              onClose={() => setIsCreateCustomerModalOpen(false)}
              onSave={handleSaveCustomer}
              t={t}
            />
          </div>
        </div>
      );
    }

    // Customer Search Input Component with Fuzzy Search
    function CustomerSearchInput({ value, onChange, placeholder, t, language }) {
      const [suggestions, setSuggestions] = React.useState([]);
      const [showSuggestions, setShowSuggestions] = React.useState(false);
      const inputRef = React.useRef(null);

      // Load customers from localStorage
      const customers = JSON.parse(localStorage.getItem("customers") || "[]");

      // Handle input change and update suggestions
      const handleInputChange = (e) => {
        const inputValue = e.target.value;
        onChange(e);
        if (inputValue.trim()) {
          const filteredSuggestions = customers
            .filter(customer => 
              customer.name && 
              customer.name.toLowerCase().includes(inputValue.toLowerCase())
            )
            .map(customer => customer.name);
          setSuggestions(filteredSuggestions);
          setShowSuggestions(true);
        } else {
          setSuggestions([]);
          setShowSuggestions(false);
        }
      };

      // Handle suggestion click
      const handleSuggestionClick = (suggestion) => {
        onChange({ target: { value: suggestion } });
        setSuggestions([]);
        setShowSuggestions(false);
      };

      // Handle click outside to close suggestions
      React.useEffect(() => {
        const handleClickOutside = (event) => {
          if (inputRef.current && !inputRef.current.contains(event.target)) {
            setShowSuggestions(false);
          }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
      }, []);

      return (
        <div className="relative flex-1">
          <label className="block text-sm font-medium mb-1">{t.customerName}</label>
          <input
            ref={inputRef}
            type="text"
            value={value}
            onChange={handleInputChange}
            placeholder={t.customerNamePlaceholder}
            className="border p-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          {showSuggestions && suggestions.length > 0 && (
            <ul className="absolute z-10 w-full bg-white border rounded shadow-lg mt-1 max-h-60 overflow-auto">
              {suggestions.map((suggestion, index) => (
                <li
                  key={index}
                  onClick={() => handleSuggestionClick(suggestion)}
                  className="p-2 hover:bg-blue-100 cursor-pointer"
                >
                  {suggestion}
                </li>
              ))}
            </ul>
          )}
        </div>
      );
    }

    // Batch Invoice App Component
    function BatchInvoiceApp() {
      const [searchTicketId, setSearchTicketId] = React.useState("");
      const [searchAmount, setSearchAmount] = React.useState("");
      const [searchDate, setSearchDate] = React.useState("");
      const [searchCustomerName, setSearchCustomerName] = React.useState("");
      const [filteredTickets, setFilteredTickets] = React.useState([]);
      const [selectedTickets, setSelectedTickets] = React.useState([]);
      const [isInvoiceModalOpen, setIsInvoiceModalOpen] = React.useState(false);
      const [language, setLanguage] = React.useState(localStorage.getItem('language') || 'zh');

      // Update document language and title on language change
      React.useEffect(() => {
        document.documentElement.lang = language;
        document.title = translations[language].title;
      }, [language]);

      // Handle language change
      const handleLanguageChange = (lang) => {
        setLanguage(lang);
        localStorage.setItem('language', lang);
      };

      // Load tickets from localStorage and listen for storage changes
      React.useEffect(() => {
        const loadTickets = () => {
          try {
            const savedTickets = JSON.parse(localStorage.getItem("tickets") || "[]");
            const savedInvoices = JSON.parse(localStorage.getItem("invoices") || "[]");
            const normalizedTickets = savedTickets.map(ticket => ({
              ...ticket,
              type: ticket.type || translations[language].ticket,
              id: ticket.id || `TICKET-${Date.now()}`,
              timestamp: ticket.timestamp || new Date().toLocaleString(language === 'es' ? 'es-ES' : 'zh-CN'),
              total: ticket.total || 0,
              items: ticket.items || [],
              customerName: ticket.customerName || translations[language].defaultCustomer,
              isInvoiced: ticket.isInvoiced || false,
              invoiceId: ticket.invoiceId || null
            }));
            const receiptTickets = normalizedTickets.filter(ticket => 
              ticket.type === translations[language].ticket && 
              !ticket.isInvoiced && 
              !selectedTickets.some(selected => selected.id === ticket.id)
            );
            setFilteredTickets(receiptTickets.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)));
          } catch (error) {
            console.error('Error loading tickets:', error);
            setFilteredTickets([]);
          }
        };

        loadTickets();
        window.addEventListener('storage', loadTickets);
        return () => window.removeEventListener('storage', loadTickets);
      }, [selectedTickets, language]);

      // Debounce function to limit rapid filtering
      const debounce = (func, delay) => {
        let timeoutId;
        return (...args) => {
          clearTimeout(timeoutId);
          timeoutId = setTimeout(() => func(...args), delay);
        };
      };

      // Filter tickets based on search inputs
      const filterTickets = (ticketId, amount, date, customerName) => {
        try {
          const savedTickets = JSON.parse(localStorage.getItem("tickets") || "[]");
          const normalizedTickets = savedTickets.map(ticket => ({
            ...ticket,
            type: ticket.type || translations[language].ticket,
            id: ticket.id || `TICKET-${Date.now()}`,
            timestamp: ticket.timestamp || new Date().toLocaleString(language === 'es' ? 'es-ES' : 'zh-CN'),
            total: ticket.total || 0,
            items: ticket.items || [],
            customerName: ticket.customerName || translations[language].defaultCustomer,
            isInvoiced: ticket.isInvoiced || false,
            invoiceId: ticket.invoiceId || null
          }));
          const receiptTickets = normalizedTickets.filter(ticket => 
            ticket.type === translations[language].ticket && 
            !ticket.isInvoiced && 
            !selectedTickets.some(selected => selected.id === ticket.id)
          );
          const filtered = receiptTickets.filter((ticket) => {
            const matchesTicketId = ticketId 
              ? ticket.id.toLowerCase().includes(ticketId.toLowerCase()) 
              : true;
            const matchesAmount = amount 
              ? ticket.total && ticket.total.toFixed(2) === parseFloat(amount).toFixed(2) 
              : true;
            const matchesDate = date && ticket.timestamp 
              ? ticket.timestamp.includes(date) 
              : true;
            const matchesCustomerName = customerName 
              ? ticket.customerName.toLowerCase().includes(customerName.toLowerCase()) 
              : true;
            return matchesTicketId && matchesAmount && matchesDate && matchesCustomerName;
          });
          setFilteredTickets(filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)));
        } catch (error) {
          console.error('Error filtering tickets:', error);
          setFilteredTickets([]);
        }
      };

      // Debounced filter function
      const debouncedFilter = React.useCallback(debounce((ticketId, amount, customerName) => {
        filterTickets(ticketId, amount, searchDate, customerName);
      }, 300), [searchDate, selectedTickets, language]);

      // Handle ticket ID change
      const handleTicketIdChange = (e) => {
        const value = e.target.value;
        setSearchTicketId(value);
        debouncedFilter(value, searchAmount, searchCustomerName);
      };

      // Handle amount change
      const handleAmountChange = (e) => {
        const value = e.target.value;
        setSearchAmount(value);
        debouncedFilter(searchTicketId, value, searchCustomerName);
      };

      // Handle date change (no real-time filtering)
      const handleDateChange = (e) => {
        setSearchDate(e.target.value);
      };

      // Handle customer name change
      const handleCustomerNameChange = (e) => {
        const value = e.target.value;
        setSearchCustomerName(value);
        debouncedFilter(searchTicketId, searchAmount, value);
      };

      // Handle search button click (for date filtering)
      const handleSearch = () => {
        filterTickets(searchTicketId, searchAmount, searchDate, searchCustomerName);
      };

      // Reset filteredTickets when all search inputs are empty
      React.useEffect(() => {
        if (!searchTicketId && !searchAmount && !searchDate && !searchCustomerName) {
          try {
            const savedTickets = JSON.parse(localStorage.getItem("tickets") || "[]");
            const normalizedTickets = savedTickets.map(ticket => ({
              ...ticket,
              type: ticket.type || translations[language].ticket,
              id: ticket.id || `TICKET-${Date.now()}`,
              timestamp: ticket.timestamp || new Date().toLocaleString(language === 'es' ? 'es-ES' : 'zh-CN'),
              total: ticket.total || 0,
              items: ticket.items || [],
              customerName: ticket.customerName || translations[language].defaultCustomer,
              isInvoiced: ticket.isInvoiced || false,
              invoiceId: ticket.invoiceId || null
            }));
            const receiptTickets = normalizedTickets.filter(ticket => 
              ticket.type === translations[language].ticket && 
              !ticket.isInvoiced && 
              !selectedTickets.some(selected => selected.id === ticket.id)
            );
            setFilteredTickets(receiptTickets.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)));
          } catch (error) {
            console.error('Error resetting tickets:', error);
            setFilteredTickets([]);
          }
        }
      }, [searchTicketId, searchAmount, searchDate, searchCustomerName, selectedTickets, language]);

      // Move ticket to selected (right container)
      const handleAddTicket = (ticket) => {
        setSelectedTickets(prev => [...prev, ticket]);
        setFilteredTickets(prev => prev.filter(t => t.id !== ticket.id));
      };

      // Remove ticket from selected (right container)
      const handleRemoveTicket = (ticket) => {
        setSelectedTickets(prev => prev.filter(t => t.id !== ticket.id));
        setFilteredTickets(prev => [...prev, ticket].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)));
      };

      // Clear all selected tickets
      const handleClearTickets = () => {
        setFilteredTickets(prev => [...prev, ...selectedTickets].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)));
        setSelectedTickets([]);
      };

      // Handle batch invoice creation
      const handleCreateInvoice = () => {
        if (selectedTickets.length === 0) {
          alert(translations[language].errorNoTicketsSelected);
          return;
        }

        const hasCustomerInfo = selectedTickets.every(ticket => ticket.customerName && ticket.customerName !== translations[language].defaultCustomer);
        if (!hasCustomerInfo) {
          setIsInvoiceModalOpen(true);
          return;
        }

        generateInvoice();
      };

      // Generate invoice and update tickets
      const generateInvoice = (customerInfo = null) => {
        try {
          const savedTickets = JSON.parse(localStorage.getItem("tickets") || "[]");
          const invoiceId = `INV-${Date.now()}`;
          const totalAmount = selectedTickets.reduce((sum, ticket) => sum + (ticket.total || 0), 0);
          const items = selectedTickets.flatMap(ticket => ticket.items || []);
          const customer = customerInfo || {
            customerName: selectedTickets[0].customerName,
            phone: selectedTickets[0].phone,
            taxId: selectedTickets[0].taxId
          };

          const invoice = {
            id: invoiceId,
            timestamp: new Date().toLocaleString(language === 'es' ? 'es-ES' : 'zh-CN'),
            tickets: selectedTickets.map(ticket => ticket.id),
            items,
            total: totalAmount,
            customerName: customer.customerName,
            phone: customer.phone,
            taxId: customer.taxId
          };

          const savedInvoices = JSON.parse(localStorage.getItem("invoices") || "[]");
          localStorage.setItem("invoices", JSON.stringify([...savedInvoices, invoice]));

          // Update selected tickets with isInvoiced and invoiceId instead of removing them
          const updatedTickets = savedTickets.map(ticket => {
            if (selectedTickets.some(t => t.id === ticket.id)) {
              return {
                ...ticket,
                isInvoiced: true,
                invoiceId: invoiceId,
                customerName: customer.customerName,
                phone: customer.phone,
                taxId: customer.taxId
              };
            }
            return ticket;
          });
          localStorage.setItem("tickets", JSON.stringify(updatedTickets));
          setSelectedTickets([]);
          setFilteredTickets(prev => prev.filter(t => updatedTickets.some(ut => ut.id === t.id && !ut.isInvoiced)));
          // Redirect to tickets.html
          window.location.href = 'tickets.html';
        } catch (error) {
          console.error('Error generating invoice:', error);
          alert(translations[language].errorGenerateInvoice);
        }
      };

      // Handle invoice modal confirm
      const handleInvoiceConfirm = (customerInfo) => {
        generateInvoice(customerInfo);
        setIsInvoiceModalOpen(false);
      };

      const t = translations[language];

      return (
        <ErrorBoundary t={t}>
          <div className="flex h-screen">
            <div className="w-16 bg-gray-900 text-white flex flex-col items-center py-4 fixed h-full shadow-lg">
              <h1 className="text-lg font-bold mb-8">{t.pos}</h1>
              <nav className="flex flex-col space-y-4">
                <a href="index.html" className="p-2 rounded-full hover:bg-gray-700" title={t.sales}>ğŸ›’</a>
                <a href="#" className="p-2 rounded-full hover:bg-gray-700" title={t.inventory}>ğŸ“¦</a>
                <a href="#" className="p-2 rounded-full hover:bg-gray-700" title={t.membership}>ğŸ‘¤</a>
                <a href="#" className="p-2 rounded-full hover:bg-gray-700" title={t.payments}>ğŸ’³</a>
                <a href="#" className="p-2 rounded-full hover:bg-gray-700" title={t.reports}>ğŸ“Š</a>
                <a href="cliente.html" className="p-2 rounded-full hover:bg-gray-700" title={t.users}>ğŸ”’</a>
                <a href="tickets.html" className="p-2 rounded-full bg-blue-600" title={t.tickets}>ğŸ«</a>
                <a href="deuda.html" className="p-2 rounded-full hover:bg-gray-700" title={t.debt}>ğŸ“‹</a>
              </nav>
            </div>
            <div className="ml-16 w-full bg-white p-6 h-screen overflow-auto">
              <div className="flex justify-between items-center mb-6">
                <div className="flex items-center">
                  <h2 className="text-2xl font-bold mr-4">{t.batchInvoice}</h2>
                  <select
                    value={language}
                    onChange={(e) => handleLanguageChange(e.target.value)}
                    className="p-1 rounded bg-gray-200 text-sm"
                  >
                    <option value="es">{t.spanish}</option>
                    <option value="zh">{t.chinese}</option>
                  </select>
                </div>
                <a href="tickets.html" className="bg-gray-500 text-white p-3 rounded text-lg hover:bg-gray-600">
                  {t.return}
                </a>
              </div>
              <div className="mb-6 space-y-4">
                <div className="flex space-x-4">
                  <div className="flex-1">
                    <label className="block text-sm font-medium mb-1">{t.ticketId}</label>
                    <input
                      type="text"
                      value={searchTicketId}
                      onChange={handleTicketIdChange}
                      placeholder={t.ticketIdPlaceholder}
                      className="border p-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                  <div className="flex-1">
                    <label className="block text-sm font-medium mb-1">{t.amount}</label>
                    <input
                      type="number"
                      step="0.01"
                      value={searchAmount}
                      onChange={handleAmountChange}
                      placeholder={t.amountPlaceholder}
                      className="border p-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                  <div className="flex-1">
                    <label className="block text-sm font-medium mb-1">{t.date}</label>
                    <input
                      type="date"
                      value={searchDate}
                      onChange={handleDateChange}
                      className="border p-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                  <CustomerSearchInput
                    value={searchCustomerName}
                    onChange={handleCustomerNameChange}
                    placeholder={t.customerNamePlaceholder}
                    t={t}
                    language={language}
                  />
                </div>
                <button
                  onClick={handleSearch}
                  className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                >
                  {t.search}
                </button>
              </div>
              <div className="flex space-x-4 h-[calc(100vh-200px)]">
                <div className="w-1/2 bg-gray-50 p-4 rounded-lg shadow overflow-auto">
                  <h3 className="text-lg font-semibold mb-4">{t.availableTickets}</h3>
                  {filteredTickets.length === 0 ? (
                    <p className="text-gray-500">{t.noTickets}</p>
                  ) : (
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="bg-gray-200">
                          <th className="border p-3 text-left">{t.ticketId}</th>
                          <th className="border p-3 text-left">{t.date}</th>
                          <th className="border p-3 text-left">{t.customer}</th>
                          <th className="border p-3 text-left">{t.total}</th>
                          <th className="border p-3 text-left">{t.actions}</th>
                        </tr>
                      </thead>
                      <tbody>
                        {filteredTickets.map((ticket) => (
                          <tr key={ticket.id}>
                            <td className="border p-3">{ticket.id}</td>
                            <td className="border p-3">{ticket.timestamp}</td>
                            <td className="border p-3">{ticket.customerName}</td>
                            <td className="border p-3">â‚¬{ticket.total.toFixed(2)}</td>
                            <td className="border p-3">
                              <button
                                onClick={() => handleAddTicket(ticket)}
                                className="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600"
                                disabled={!(ticket.id && ticket.timestamp && ticket.total)}
                              >
                                â¡ï¸
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  )}
                </div>
                <div className="w-1/2 bg-gray-50 p-4 rounded-lg shadow overflow-auto relative">
                  <h3 className="text-lg font-semibold mb-4">{t.selectedTickets}</h3>
                  {selectedTickets.length === 0 ? (
                    <p className="text-gray-500">{t.noSelectedTickets}</p>
                  ) : (
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="bg-gray-200">
                          <th className="border p-3 text-left">{t.ticketId}</th>
                          <th className="border p-3 text-left">{t.date}</th>
                          <th className="border p-3 text-left">{t.customer}</th>
                          <th className="border p-3 text-left">{t.total}</th>
                          <th className="border p-3 text-left">{t.actions}</th>
                        </tr>
                      </thead>
                      <tbody>
                        {selectedTickets.map((ticket) => (
                          <tr key={ticket.id}>
                            <td className="border p-3">{ticket.id}</td>
                            <td className="border p-3">{ticket.timestamp}</td>
                            <td className="border p-3">{ticket.customerName}</td>
                            <td className="border p-3">â‚¬{ticket.total.toFixed(2)}</td>
                            <td className="border p-3">
                              <button
                                onClick={() => handleRemoveTicket(ticket)}
                                className="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 mr-2"
                              >
                                â¬…ï¸
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  )}
                  {selectedTickets.length > 0 && (
                    <div className="absolute bottom-4 right-4 flex space-x-2">
                      <button
                        onClick={handleClearTickets}
                        className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                      >
                        {t.clear}
                      </button>
                      <button
                        onClick={handleCreateInvoice}
                        className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
                      >
                        {t.createInvoice} ({t.totalAmount.replace('{amount}', selectedTickets.reduce((sum, ticket) => sum + (ticket.total || 0), 0).toFixed(2))})
                      </button>
                    </div>
                  )}
                </div>
              </div>
              <InvoiceModal
                isOpen={isInvoiceModalOpen}
                onClose={() => setIsInvoiceModalOpen(false)}
                onConfirm={handleInvoiceConfirm}
                t={t}
              />
            </div>
          </div>
        </ErrorBoundary>
      );
    }

    // Render the app using createRoot
    const rootElement = document.getElementById("root");
    const root = ReactDOM.createRoot(rootElement);
    root.render(<BatchInvoiceApp />);
  </script>
</body>
</html>